<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper
    namespace="com.tenco.team_two_flight_ticket.reservation.ReservationRepository">
   	<select id="getMyTravel" resultType="com.tenco.team_two_flight_ticket.user.UserResponse$GetMyTravelDTO">
   		select r.id as id, is_payed, user_id, r.created_at as created_at, payment_deadline
   		, reservation_num, status_enum, airline, arrival_city, departure_airport, departure_city
   		, flight_name, departure_time, arrival_time  
   		from reservation_tb as r
		join ticket_tb as t
		on r.id = t.reservation_id
   		where user_id = #{userId}
   		and status_enum = #{statusEnum}
   		<if test="sort == 'true'">
   		and is_payed = true
   		</if>
   		<if test="sort == 'false'">
   		and is_payed = false
   		</if>
   		order by departure_time desc
   	</select>
   	
   	<select id="getMyTripCount" resultType="int">
   		select count(*)
   		from reservation_tb as r
   		join ticket_tb as t
   		on r.id = t.reservation_id
   		where user_id = #{userId}
   		and status_enum = #{statusEnum}
   		<if test="sort == 'true'">
   		and is_payed = true
   		</if>
   		<if test="sort == 'false'">
   		and is_payed = false
   		</if>
   	</select>

	<select id="reservationPayment" resultMap="reservationPaymentResultMap">

		SELECT ub.username, rb.reservation_num, rb.passenger_amount, tb.taxes, cb.discounting_price, pb.first_name, pb.last_name, tb.total_price, tb.departure_time
		FROM ticket_tb as tb
				 left join reservation_tb as rb
						   on tb.id = rb.id
				 left join passenger_tb as pb
						   on rb.id = pb.id
				 left join user_tb as ub
						   on ub.id = rb.id
				 left join hascoupon_tb as hb
						   on hb.user_id = ub.id
				 left join coupon_tb as cb
						   on cb.id = hb.coupon_id
		where ub.id = #{userId}
    </select>

	<resultMap id="reservationPaymentResultMap" type="com.tenco.team_two_flight_ticket.reservation.ReservationResponse$ReservationPaymentDTO">
		<result property="username" column="username"/>
		<result property="reservationNum" column="reservation_num"/>
		<result property="passengerAmount" column="passenger_amount"/>
		<result property="taxes" column="taxes"/>
		<result property="couponDiscountingPrice" column="discounting_price"/>
		<result property="passengerFirstName" column="first_name"/>
		<result property="passengerLastName" column="last_name"/>
		<result property="totalPrice" column="total_price"/>
		<result property="departureTime" column="departure_time"/>
	</resultMap>
</mapper>